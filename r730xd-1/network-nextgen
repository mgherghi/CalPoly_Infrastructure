# Unload bonding module 
modprobe -r bonding || true

# SETUP MTU
modprobe bonding mode=802.3ad miimon=100 lacp_rate=1 xmit_hash_policy=layer3+4
ip link add mlnx-bond type bond
ip link set enp132s0 mtu 9000
ip link set enp132s0d1 mtu 9000
ip link set mlnx-bond mtu 9000
ip link set enp132s0 master mlnx-bond
ip link set enp132s0d1 master mlnx-bond
ip link set mlnx-bond mtu 9000
ip link  set mlnx-bond up

# SETUP DRBD REPLICATION
ip link add link mlnx-bond name rdma type vlan id 10
ip link set dev rdma type vlan egress-qos-map 0:3
ip link set rdma up
ip link set rdma mtu 9000
ip addr add 4.1.0.7/24 dev rdma
ip route del default dev rdma 2>/dev/null || true
ip route add prohibit 0.0.0.0/0 dev rdma metric 50

# SETUP LINSTOR MGMT 
ip link add link mlnx-bond name linstor-mgmt type vlan id 20
ip link set linstor-mgmt mtu 9000 
ip link set linstor-mgmt up
ip addr add 4.2.0.7/24 dev linstor-mgmt

# SETUP OVN NETWORK
ip link add link mlnx-bond name ovn-mgmt type vlan id 30
ip link set ovn-mgmt mtu 9000
ip link set ovn-mgmt up
ip addr add 4.3.0.7/24 dev ovn-mgmt

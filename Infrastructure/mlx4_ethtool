#!/usr/bin/env bash
set -euo pipefail

echo "Detecting Mellanox CX3 Pro NICs ..."

for dev in /sys/bus/pci/devices/*; do
  # Mellanox vendor ID
  [[ "$(cat "$dev/vendor" 2>/dev/null)" != "0x15b3" ]] && continue

  # CX3 Pro uses mlx4 driver
  [[ ! -e "$dev/driver" ]] && continue
  [[ "$(basename "$(readlink "$dev/driver")")" != "mlx4_core" ]] && continue

  # Enumerate all netdevs under this PCI function (ports)
  if [[ -d "$dev/net" ]]; then
    for iface in "$dev"/net/*; do
      iface=$(basename "$iface")
      [[ "$iface" == "lo" ]] && continue

      echo "Configuring CX3 Pro port: $iface"
      ethtool -G "$iface" rx 8192 tx 8192
      ethtool -A "$iface" rx on tx on 
      ethtool -K "$iface" tso on gso on gro on lro off
    done
  fi
done

# increase TCP max buffer size setable using setsockopt() to 512MB
sysctl -w net.core.rmem_max = 536870912
sysctl -w net.core.wmem_max = 536870912
# increase Linux autotuning TCP buffer limit to 256MB
sysctl -w net.ipv4.tcp_rmem = 4096 87380 268435456
sysctl -w net.ipv4.tcp_wmem = 4096 65536 268435456
# recommended for hosts with jumbo frames enabled
sysctl -w net.ipv4.tcp_mtu_probing=1
# recommended to enable 'fair queueing'
sysctl -w net.core.default_qdisc = fq
sysctl -w net.ipv4.conf.all.rp_filter=0
sysctl -w net.ipv4.conf.default.rp_filter=0

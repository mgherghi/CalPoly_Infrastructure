#!/bin/bash

hostname=$(hostname)

# SETUP PATH
path_setup() {
    echo "export PATH=$PATH:/sbin" >> /home/mihai/.bashrc
    source /home/mihai/.bashrc
}


#SETUP INCUS REPO AND KEY FUNCTION
incus_setup() {
    # Create keyrings directory if missing

    echo "[*] Downloading Incus apt key..."
    wget -qO /etc/apt/keyrings/zabbly.asc https://pkgs.zabbly.com/key.asc

    echo "[*] Configuring Incus apt repository..."
    cat <<EOF | sudo tee /etc/apt/sources.list.d/zabbly-incus-stable.sources > /dev/null
    Enabled: yes
    Types: deb
    URIs: https://pkgs.zabbly.com/incus/stable
    Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
    Components: main
    Architectures: $(dpkg --print-architecture)
    Signed-By: /etc/apt/keyrings/zabbly.asc
EOF



    echo "[*] Incus repo setup complete."
    apt update && apt install incus qemu-system -y 
}

# SETUP LINSTOR KEY AND REPO
linstor_setup() {
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/linbit.asc -O /etc/apt/keyrings/linbit.asc && wait
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/linstor.sources -O /etc/apt/sources.list.d/linstor.sources && wait
    apt update 
    echo "[*] linstor repo setup complete."
}

# CREATE BOOT FOLDERS
mkdir -p /home/.essentials
mkdir -p /home/.essentials/startup 

# GET NETWORK BOOTUP SCRIPT
wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/network -O /home/.essentials/startup/network && wait

# SETUP OF PERFORMANCE GOVERNER
wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/cpupower -O /home/.essentials/startup/cpupower && wait

# SETUP BOOT SCRIPT 
echo "post-up /home/.essentials/boot_script" >> /etc/network/interfaces  && wait

# DOWNLOAD TCP SYSCTL OPTIMIZATIONS
wget https://github.com/mgherghi/CalPoly_Infrastructure/blob/main/"$(hostname)"/10-tcp.conf -O /etc/sysctl.d/10-tcp.conf

# DOWNLOAD MLNX-PREP
wget https://github.com/mgherghi/CalPoly_Infrastructure/blob/main/"$(hostname)"/mlnx-prep -O /home/.essentials/startup/mlnx-prep && wait


# SETUP APP INSTALLS
apt_setup() {
    apt update && apt install ethtool vlan rdma-core  libibverbs1 librdmacm1 libibmad5 libibumad3 librdmacm1 ibverbs-providers rdmacm-utils infiniband-diags libfabric1 ibverbs-utils linstor-satellite ovn-host linux-cpupower linux-headers-amd64 linux-image-amd64 drbd-utils bcache-tools tini lvm2 zstd socat curl udev lsscsi nvme-cli cryptsetup thin-provisioning-tools thin-send-recv dkms drbd-dkms drbd-utils nvme-cli lvm2 firmware-linux -y  && wait
    echo "8021q" >> /etc/modules
    update-initramfs -u -k all 
}

# SETUP NVIDIA INSTALLS
nvidia_setup() {
    wget https://developer.download.nvidia.com/compute/cuda/repos/debian12/x86_64/cuda-keyring_1.1-1_all.deb
    dpkg -i cuda-keyring_1.1-1_all.deb
    apt update
    if [[ "$hostname" == "supermicro" ]]; then
        apt install cuda-toolkit cuda-drivers nvidia-container-toolkit libnvidia-container-tools libnvidia-container1 -y
    else
        apt install cuda-toolkit nvidia-open nvidia-container-toolkit libnvidia-container-tools libnvidia-container1 -y
    fi

    # Setup symbolic link for incus staging
    ln -s /usr/local/cuda /srv/cuda

    # Add nvidia path and ld_library_path
    echo "export CUDA_HOME=/usr/local/cuda" >> /home/mihai/.bashrc
    echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64" >> /home/mihai/.bashrc
    echo "export PATH=$PATH:$CUDA_HOME/bin" >> /home/mihai/.bashrc
    source /home/mihai/.bashrc

}

path_setup
linstor_setup
apt_setup

hostname=$(hostname)

if [[ "$hostname" == "r730xd-1" ]]; then

  
    # Apt install for remaining stuff
  apt update -y && apt install ovn-central linstor-controller linstor-client python3-setuptools

    # ALLOW MULTIPATH FOR NVME
  wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/nvme_core.conf -O /etc/modprobe.d/nvme_core.conf && wait

    # CHANGE IO POLICY ON NVME DRIVES
  wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/iopolicy -O /home/.essentials/startup/iopolicy && wait

    # SAVE OVN-CENTRAL FILE TO HOST
  wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovn-central -O /etc/default/ovn-central

    # RUN OVN-CENTRAL COMMAND
  wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
  echo "/home/.essentials/startup/iopolicy" > /home/.essentials/boot_script
  echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
  echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
  echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script


elif [[ "$hostname" == "r730xd-2" ]]; then

    # Apt install for remaining stuff
    apt update -y && apt install ovn-central

    # ALLOW MULTIPATH FOR NVME
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/nvme_core.conf -O /etc/modprobe.d/nvme_core.conf && wait  

    # CHANGE IO POLICY ON NVME DRIVES
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/iopolicy -O /home/.essentials/startup/iopolicy && wait

    # SAVE OVN-CENTRAL FILE TO HOST
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovn-central -O /etc/default/ovn-central

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/iopolicy" > /home/.essentials/boot_script
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

elif [[ "$hostname" == "r730xd-3" ]]; then

    # Remaning apt packages
    apt update -y && apt install ovn-central

    # ALLOW MULTIPATH FOR NVME
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/nvme_core.conf -O /etc/modprobe.d/nvme_core.conf && wait 

    # CHANGE IO POLICY ON NVME DRIVES
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/iopolicy -O /home/.essentials/startup/iopolicy && wait

    # SAVE OVN-CENTRAL FILE TO HOST
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovn-central -O /etc/default/ovn-central

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/iopolicy" > /home/.essentials/boot_script
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script


elif [[ "$hostname" == "supermicro" ]]; then
    apt update -y 

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup
    nvidia_setup

elif [[ "$hostname" == "r620" ]]; then

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup

elif [[ "$hostname" == "gigabyte" ]]; then

    # Setup Gigabyte
    apt update

    # ALLOW MULTIPATH FOR NVME
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/nvme_core.conf -O /etc/modprobe.d/nvme_core.conf && wait  

    # CHANGE IO POLICY ON NVME DRIVES
    wget https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/Infrastructure/iopolicy -O /home/.essentials/startup/iopolicy && wait

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash


    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/iopolicy" > /home/.essentials/boot_script
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup
    nvidia_setup

elif [[ "$hostname" == "r720-1" ]]; then

    # Setup r720-1
    apt update

    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup

elif [[ "$hostname" == "r720-2" ]]; then

    # Setup r720-2
    apt update
    
    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup

elif [[ "$hostname" == "r720-3" ]]; then

    # Setup r720-1
    apt update
    
    # RUN OVN-CENTRAL COMMAND
    wget -qO- https://raw.githubusercontent.com/mgherghi/CalPoly_Infrastructure/refs/heads/main/"$(hostname)"/ovs-command | bash

    # CONFIGURE BOOT SCRIPT
    echo "/home/.essentials/startup/cpupower" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/mlnx-prep" >> /home/.essentials/boot_script
    echo "/home/.essentials/startup/network" >> /home/.essentials/boot_script

    # RUN SETUP
    incus_setup

else
  echo "Unknown host: $hostname"
fi

chmod u+x /home/.essentials/startup/* && chmod -R u+x /home/.essentials/* && wait
